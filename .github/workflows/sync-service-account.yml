name: ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ï¼‰

on:
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸã‚’å®Ÿè¡Œ'
        required: false
        default: true
        type: boolean

jobs:
  sync-schedule-service-account:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
    
    - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: uvã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆé«˜é€ŸåŒ–ç‰ˆï¼‰
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆuvã‚’ä½¿ç”¨ï¼‰
      run: |
        echo "ðŸ“¦ uvã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹ï¼‰..."
        uv sync --locked --no-dev || {
          echo "âš ï¸  ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å¯¾å‡¦ã—ã¾ã™..."
          uv lock
          uv sync --no-dev --no-cache
        }
        echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
    
    - name: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼æƒ…å ±ã‚’è¨­å®š
      env:
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        CALENDAR_ID: ${{ secrets.CALENDAR_ID }}
      run: |
        echo "ðŸ” ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼æƒ…å ±ã‚’è¨­å®šä¸­..."
        
        # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > service-account.json
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã¨æœ‰åŠ¹æ€§ã‚’ç¢ºèª
        if [ ! -f service-account.json ] || [ ! -s service-account.json ]; then
          echo "âŒ service-account.jsonãŒç©ºã¾ãŸã¯å­˜åœ¨ã—ã¾ã›ã‚“"
          echo "ðŸ”§ GOOGLE_SERVICE_ACCOUNT_JSON secretãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„"
          exit 1
        fi
        
        # JSONå½¢å¼ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
        if ! python -m json.tool service-account.json > /dev/null 2>&1; then
          echo "âŒ service-account.jsonãŒæœ‰åŠ¹ãªJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
        sa_size=$(stat -c%s service-account.json)
        echo "ðŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª:"
        echo "  service-account.json: ${sa_size} bytes"
        
        # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã®è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ãƒ»æ©Ÿå¯†æƒ…å ±ã¯é™¤å¤–ï¼‰
        echo "ðŸ” ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±:"
        python -c "import json; data=json.load(open('service-account.json')); print(f'  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: {data.get(\"project_id\", \"ä¸æ˜Ž\")}'); print(f'  ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID: {data.get(\"client_id\", \"ä¸æ˜Ž\")}'); print(f'  ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¡ãƒ¼ãƒ«: {data.get(\"client_email\", \"ä¸æ˜Ž\")}')"
        
        echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£å¸¸ã«è¨­å®šã—ã¾ã—ãŸ"
    
    - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ç”¨ï¼‰
      env:
        CALENDAR_ID: ${{ secrets.CALENDAR_ID }}
      run: |
        echo "âš™ï¸ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ..."
        cat > config.ini << EOF
        [DEFAULT]
        target_url = https://aikatsu-academy.com/schedule/
        
        [GoogleCalendar]
        # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã‚’ä½¿ç”¨
        auth_method = service_account
        service_account_file = ../service-account.json
        calendar_id = ${{ secrets.CALENDAR_ID }}
        
        [Sync]
        update_interval_hours = 6
        
        # ã‚«ãƒ†ã‚´ãƒª â†’ çµµæ–‡å­—ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆåŸºæœ¬ï¼‰
        [CategoryEmojis]
        shortå‹•ç”» = ðŸ“±
        ã‚«ãƒ¼ãƒ‰ = ðŸŽ´
        ã‚°ãƒƒã‚º = ðŸ§¸
        ã‚¹ãƒšã‚·ãƒ£ãƒ« = âœ¨
        ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ— = ðŸ‘‘

        # ãƒãƒ£ãƒ³ãƒãƒ« â†’ çµµæ–‡å­—ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆ[]å†…ã®å†…å®¹ã‹ã‚‰åˆ¤å®šãƒ»æœ€å„ªå…ˆï¼‰
        [ChannelEmojis]
        ã¿ãˆã‚‹å€‹äººé…ä¿¡ = ðŸ©·
        ã¿ãˆã‚‹å€‹äººch = ðŸ©·
        ãƒ¡ã‚¨å€‹äººé…ä¿¡ = ðŸ’™
        ãƒ¡ã‚¨å€‹äººch = ðŸ’™
        ãƒ‘ãƒªãƒ³å€‹äººé…ä¿¡ = ðŸ’›
        ãƒ‘ãƒªãƒ³å€‹äººch = ðŸ’›
        ãŸã„ã‚€å€‹äººé…ä¿¡ = ðŸ’œ
        ãŸã„ã‚€å€‹äººch = ðŸ’œ
        é…ä¿¡éƒ¨ = ðŸ«
        å„å€‹äººãƒãƒ£ãƒ³ãƒãƒ« = ðŸ©·ðŸ’™ðŸ’›ðŸ’œ

        # ç‰¹åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ â†’ çµµæ–‡å­—ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆæœ€å„ªå…ˆï¼‰
        [SpecialKeywords]
        ãƒ‡ãƒŸã‚«ãƒ„é€šä¿¡ = ðŸ“°
        ã‚¢ã‚¤ã‚«ãƒ„ï¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ = ðŸ’ª
        ã‚¢ã‚¤ã‚«ãƒ„ï¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ = ðŸ”¥
        ã‚¢ã‚¤ã‚«ãƒ„ï¼ãƒ„ã‚¢ãƒ¼ã‚º = ðŸ—ºï¸
        ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼é…ä¿¡éƒ¨ = ðŸ«
        ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—é™å®š = ðŸ‘‘
        
        # ãƒãƒ£ãƒ³ãƒãƒ«URL â†’ é…ä¿¡è€…ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆGoogleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è©³ç´°ã«URLã‚’è¿½åŠ ï¼‰
        [ChannelURLs]
        ã¿ãˆã‚‹å€‹äººé…ä¿¡ = https://www.youtube.com/@himeno-mieru
        ã¿ãˆã‚‹å€‹äººch = https://www.youtube.com/@himeno-mieru
        ãƒ¡ã‚¨å€‹äººé…ä¿¡ = https://www.youtube.com/@mamimu-meh
        ãƒ¡ã‚¨å€‹äººch = https://www.youtube.com/@mamimu-meh
        ãƒ‘ãƒªãƒ³å€‹äººé…ä¿¡ = https://www.youtube.com/@wao-parin
        ãƒ‘ãƒªãƒ³å€‹äººch = https://www.youtube.com/@wao-parin
        ãŸã„ã‚€å€‹äººé…ä¿¡ = https://www.youtube.com/@rindou-taimu
        ãŸã„ã‚€å€‹äººch = https://www.youtube.com/@rindou-taimu
        ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼é…ä¿¡éƒ¨ = https://www.youtube.com/@aikatsu-academy
        å„å€‹äººãƒãƒ£ãƒ³ãƒãƒ« = ã¿ãˆã‚‹ï¼š https://www.youtube.com/@himeno-mieru ãƒ¡ã‚¨ï¼š https://www.youtube.com/@mamimu-meh ãƒ‘ãƒªãƒ³ï¼š https://www.youtube.com/@wao-parin ãŸã„ã‚€ï¼š https://www.youtube.com/@rindou-taimu
        EOF
        echo "âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
    
    - name: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸã‚’å®Ÿè¡Œï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ï¼‰
      run: |
        cd src
        echo "ðŸš€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸã‚’é–‹å§‹ã—ã¾ã™ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ï¼‰..."
        echo "ðŸ“ å®Ÿè¡Œç’°å¢ƒ:"
        echo "  ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
        echo "  Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $(python --version)"
        echo "  èªè¨¼æ–¹å¼: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ"
        echo "  è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: ../config.ini"
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ ! -f ../config.ini ]; then
          echo "âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ../config.ini"
          exit 1
        fi
        
        # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ ! -f ../service-account.json ]; then
          echo "âŒ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ../service-account.json"
          exit 1
        fi
        
        echo "âœ… å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒã™ã¹ã¦æƒã„ã¾ã—ãŸ"
        echo "ðŸ“‹ å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰: uv run python main.py --manual --config ../config.ini"
        
        # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã§ã®åŒæœŸå®Ÿè¡Œ
        if uv run python main.py --manual --config ../config.ini; then
          echo "âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ï¼‰"
          echo "ðŸŽ‰ ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œã®å¿ƒé…ã¯ã‚‚ã†ã‚ã‚Šã¾ã›ã‚“ï¼"
        else
          exit_code=$?
          echo "âŒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: $exit_code)"
          echo "ðŸ”§ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"
          echo "  1. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã®ç¢ºèª:"
          echo "     - Google Cloud Consoleã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæœ‰åŠ¹ã‹"
          echo "     - JSON keyãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„ã‹"
          echo "     - GOOGLE_SERVICE_ACCOUNT_JSON secretãŒæœ€æ–°ã‹"
          echo "  2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ¨©é™ã®ç¢ºèª:"
          echo "     - Google Calendarã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå…±æœ‰ã•ã‚Œã¦ã„ã‚‹ã‹"
          echo "     - æ¨©é™ãŒã€Œäºˆå®šã®å¤‰æ›´ãŠã‚ˆã³ç®¡ç†ã€ã«ãªã£ã¦ã„ã‚‹ã‹"
          echo "  3. ãã®ä»–:"
          echo "     - CALENDAR_ID secretãŒæ­£ã—ã„ã‹"
          echo "     - å…¬å¼ã‚µã‚¤ãƒˆã®æ§‹é€ å¤‰æ›´ã‚„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™"
          echo "  ðŸ“– è©³ç´°: docs/SERVICE_ACCOUNT_SETUP.md"
          
          # ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°ã®ã¿ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          echo ""
          echo "ðŸ” ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°æ©Ÿèƒ½ã®ç¢ºèªã‚’å®Ÿè¡Œã—ã¾ã™..."
          if python ../utils/scrape_only.py; then
            echo "âœ… ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°æ©Ÿèƒ½ã¯æ­£å¸¸ã§ã™ - å•é¡Œã¯èªè¨¼è¨­å®šã®ã¿"
          else
            echo "âŒ ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°æ©Ÿèƒ½ã«ã‚‚å•é¡ŒãŒã‚ã‚Šã¾ã™"
          fi
          
          exit $exit_code
        fi
    
    - name: å®Ÿè¡Œçµæžœã‚’Slackã«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          message="âœ… ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸãŒæˆåŠŸã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ãƒ»å®Œå…¨è‡ªå‹•åŒ–ï¼‰"
        else
          message="âŒ ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸãŒå¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ï¼‰"
        fi
        
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$message\"}" \
            $SLACK_WEBHOOK_URL
        fi 