name: ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸ

on:
  # å®šæœŸå®Ÿè¡Œ - æ¯Žæ—¥6æ™‚ã€12æ™‚ã€18æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œï¼ˆé«˜é€ŸåŒ–ã«ã‚ˆã‚Šé »åº¦å‰Šæ¸›å¯èƒ½ï¼‰
  # JST: 15æ™‚ã€21æ™‚ã€3æ™‚
  schedule:
    - cron: '0 6,12,18 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼·åˆ¶åŒæœŸã‚’å®Ÿè¡Œï¼ˆé€šå¸¸ã®åŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œï¼‰'
        required: false
        default: true
        type: boolean

jobs:
  sync-schedule:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
    
    - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: uvã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆé«˜é€ŸåŒ–ç‰ˆï¼‰
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true  # ðŸš€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
        cache-dependency-glob: "uv.lock"
    
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆuvã‚’ä½¿ç”¨ãƒ»é«˜é€ŸåŒ–ç‰ˆï¼‰
      run: |
        echo "ðŸ“¦ uvã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹ï¼‰..."
        # ðŸš€ æœ€é©åŒ–ï¼šä¸¦åˆ—ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨é«˜é€ŸåŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚å‡¦ç†ã‚’ç¶™ç¶š
        uv sync --locked --no-dev || {
          echo "âš ï¸  ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¾ã™..."
          uv sync --locked --no-dev --no-cache
        }
        echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
    
    - name: Googleèªè¨¼æƒ…å ±ã‚’è¨­å®š
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        GOOGLE_TOKEN: ${{ secrets.GOOGLE_TOKEN }}
      run: |
        echo "Googleèªè¨¼æƒ…å ±ã‚’è¨­å®šä¸­..."
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
        echo '${{ secrets.GOOGLE_TOKEN }}' > token.json
        
        # èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèª
        if [ ! -f credentials.json ] || [ ! -s credentials.json ]; then
          echo "âŒ credentials.jsonãŒç©ºã¾ãŸã¯å­˜åœ¨ã—ã¾ã›ã‚“"
          echo "ðŸ”§ GOOGLE_CREDENTIALS secretãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„"
          exit 1
        fi
        
        if [ ! -f token.json ] || [ ! -s token.json ]; then
          echo "âŒ token.jsonãŒç©ºã¾ãŸã¯å­˜åœ¨ã—ã¾ã›ã‚“"
          echo "ðŸ”§ GOOGLE_TOKEN secretãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„"
          exit 1
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
        cred_size=$(stat -c%s credentials.json)
        token_size=$(stat -c%s token.json)
        echo "ðŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª:"
        echo "  credentials.json: ${cred_size} bytes"
        echo "  token.json: ${token_size} bytes"
        
        # JSONå½¢å¼ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
        if ! python -m json.tool credentials.json > /dev/null 2>&1; then
          echo "âŒ credentials.jsonãŒæœ‰åŠ¹ãªJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        if ! python -m json.tool token.json > /dev/null 2>&1; then
          echo "âŒ token.jsonãŒæœ‰åŠ¹ãªJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        echo "âœ… èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£å¸¸ã«è¨­å®šã—ã¾ã—ãŸ"
    
    - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      env:
        CALENDAR_ID: ${{ secrets.CALENDAR_ID }}
      run: |
        cat > config.ini << EOF
        [DEFAULT]
        target_url = https://aikatsu-academy.com/schedule/
        
        [GoogleCalendar]
        calendar_id = ${{ secrets.CALENDAR_ID }}
        credentials_file = credentials.json
        token_file = token.json
        
        [Sync]
        update_interval_hours = 6
        
        # ã‚«ãƒ†ã‚´ãƒª â†’ çµµæ–‡å­—ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆåŸºæœ¬ï¼‰
        [CategoryEmojis]
        shortå‹•ç”» = ðŸ“±
        ã‚«ãƒ¼ãƒ‰ = ðŸŽ´
        ã‚°ãƒƒã‚º = ðŸ§¸
        ã‚¹ãƒšã‚·ãƒ£ãƒ« = âœ¨
        ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ— = ðŸ‘‘

        # äººç‰© â†’ çµµæ–‡å­—ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆpã‚¿ã‚°ã®å†…å®¹ã‹ã‚‰åˆ¤å®šï¼‰
        [PersonEmojis]
        ã¿ãˆã‚‹å€‹äººé…ä¿¡ = ðŸ©·
        ã¿ãˆã‚‹å€‹äººch = ðŸ©·
        ãƒ¡ã‚¨å€‹äººé…ä¿¡ = ðŸ’™
        ãƒ¡ã‚¨å€‹äººch = ðŸ’™
        ãƒ‘ãƒªãƒ³å€‹äººé…ä¿¡ = ðŸ’›
        ãƒ‘ãƒªãƒ³å€‹äººch = ðŸ’›
        ãŸã„ã‚€å€‹äººé…ä¿¡ = ðŸ’œ
        ãŸã„ã‚€å€‹äººch = ðŸ’œ


        # ç‰¹åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ â†’ çµµæ–‡å­—ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆæœ€å„ªå…ˆï¼‰
        [SpecialKeywords]
        ãƒ‡ãƒŸã‚«ãƒ„é€šä¿¡ = ðŸ“°
        ã‚¢ã‚¤ã‚«ãƒ„ï¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ = ðŸ’ª
        ã‚¢ã‚¤ã‚«ãƒ„ï¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ = ðŸ”¥
        ã‚¢ã‚¤ã‚«ãƒ„ï¼ãƒ„ã‚¢ãƒ¼ã‚º = ðŸ—ºï¸
        ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼é…ä¿¡éƒ¨ = ðŸ«
        ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—é™å®š = ðŸ‘‘
        
        # ãƒãƒ£ãƒ³ãƒãƒ«URL â†’ é…ä¿¡è€…ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆGoogleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è©³ç´°ã«URLã‚’è¿½åŠ ï¼‰
        # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸Šã®[]å†…ã«è©²å½“ã—ãŸå ´åˆã€ãƒãƒ£ãƒ³ãƒãƒ«URLã‚’è¿½åŠ 
        [ChannelURLs]
        ã¿ãˆã‚‹å€‹äººé…ä¿¡ = https://www.youtube.com/@himeno-mieru
        ã¿ãˆã‚‹å€‹äººch = https://www.youtube.com/@himeno-mieru
        ãƒ¡ã‚¨å€‹äººé…ä¿¡ = https://www.youtube.com/@mamimu-meh
        ãƒ¡ã‚¨å€‹äººch = https://www.youtube.com/@mamimu-meh
        ãƒ‘ãƒªãƒ³å€‹äººé…ä¿¡ = https://www.youtube.com/@wao-parin
        ãƒ‘ãƒªãƒ³å€‹äººch = https://www.youtube.com/@wao-parin
        ãŸã„ã‚€å€‹äººé…ä¿¡ = https://www.youtube.com/@rindou-taimu
        ãŸã„ã‚€å€‹äººch = https://www.youtube.com/@rindou-taimu
        ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼é…ä¿¡éƒ¨ = https://www.youtube.com/@aikatsu-academy
        å„å€‹äººãƒãƒ£ãƒ³ãƒãƒ« = ã¿ãˆã‚‹ï¼š https://www.youtube.com/@himeno-mieru ãƒ¡ã‚¨ï¼š https://www.youtube.com/@mamimu-meh ãƒ‘ãƒªãƒ³ï¼š https://www.youtube.com/@wao-parin ãŸã„ã‚€ï¼š https://www.youtube.com/@rindou-taimu
        EOF
    
    - name: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸã‚’å®Ÿè¡Œ
      run: |
        cd src
        echo "ðŸš€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸã‚’é–‹å§‹ã—ã¾ã™..."
        echo "ðŸ“ å®Ÿè¡Œç’°å¢ƒ:"
        echo "  ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
        echo "  Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $(python --version)"
        echo "  è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: ../config.ini"
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ ! -f ../config.ini ]; then
          echo "âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ../config.ini"
          exit 1
        fi
        
        # èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ ! -f ../credentials.json ]; then
          echo "âŒ èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ../credentials.json"
          exit 1
        fi
        
        if [ ! -f ../token.json ]; then
          echo "âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ../token.json"
          exit 1
        fi
        
        echo "âœ… å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒã™ã¹ã¦æƒã„ã¾ã—ãŸ"
        echo "ðŸ“‹ å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰: uv run python main.py --manual --config ../config.ini"
        
        # åŒæœŸå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        if uv run python main.py --manual --config ../config.ini; then
          echo "âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        else
          exit_code=$?
          echo "âŒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: $exit_code)"
          echo "ðŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"
          echo "  1. Google Calendar APIèªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆ:"
          echo "     - GOOGLE_CREDENTIALS secretãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
          echo "     - GOOGLE_TOKEN secretãŒæœ‰åŠ¹æœŸé™å†…ã‹ç¢ºèª"
          echo "     - CALENDAR_ID secretãŒæ­£ã—ã„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‹ç¢ºèª"
          echo "  2. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼ã®å ´åˆ:"
          echo "     - å…¬å¼ã‚µã‚¤ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚„ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å¯èƒ½æ€§"
          echo "     - ã‚µã‚¤ãƒˆæ§‹é€ ã®å¤‰æ›´ã®å¯èƒ½æ€§"
          echo "  3. ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆ:"
          echo "     - ãƒ­ã‚°ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          exit $exit_code
        fi
    
    - name: å®Ÿè¡Œçµæžœã‚’Slackã«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          message="âœ… ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸãŒæˆåŠŸã—ã¾ã—ãŸï¼ˆuvã‚’ä½¿ç”¨ï¼‰"
        else
          message="âŒ ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸãŒå¤±æ•—ã—ã¾ã—ãŸï¼ˆuvã‚’ä½¿ç”¨ï¼‰"
        fi
        
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$message\"}" \
            $SLACK_WEBHOOK_URL
        fi 