name: ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸ

on:
  # å®šæœŸå®Ÿè¡Œ - æ¯Žæ—¥0æ™‚ã€3æ™‚ã€6æ™‚ã€9æ™‚ã€12æ™‚ã€14æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
  # JST: 9æ™‚ã€12æ™‚ã€15æ™‚ã€18æ™‚ã€21æ™‚ã€23æ™‚
  schedule:
    - cron: '0 0,3,6,9,12,14 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼·åˆ¶åŒæœŸã‚’å®Ÿè¡Œï¼ˆé€šå¸¸ã®åŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œï¼‰'
        required: false
        default: 'true'
        type: boolean

jobs:
  sync-schedule:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
    
    - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Googleèªè¨¼æƒ…å ±ã‚’è¨­å®š
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        GOOGLE_TOKEN: ${{ secrets.GOOGLE_TOKEN }}
      run: |
        echo "Googleèªè¨¼æƒ…å ±ã‚’è¨­å®šä¸­..."
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
        echo '${{ secrets.GOOGLE_TOKEN }}' > token.json
        
        # èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèª
        if [ ! -f credentials.json ] || [ ! -s credentials.json ]; then
          echo "âŒ credentials.jsonãŒç©ºã¾ãŸã¯å­˜åœ¨ã—ã¾ã›ã‚“"
          exit 1
        fi
        
        if [ ! -f token.json ] || [ ! -s token.json ]; then
          echo "âŒ token.jsonãŒç©ºã¾ãŸã¯å­˜åœ¨ã—ã¾ã›ã‚“"
          exit 1
        fi
        
        echo "âœ… èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£å¸¸ã«è¨­å®šã—ã¾ã—ãŸ"
    
    - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      env:
        CALENDAR_ID: ${{ secrets.CALENDAR_ID }}
      run: |
        cat > config.ini << EOF
        [DEFAULT]
        target_url = https://aikatsu-academy.com/schedule/
        
        [GoogleCalendar]
        calendar_id = ${{ secrets.CALENDAR_ID }}
        credentials_file = ../credentials.json
        token_file = ../token.json
        
        [Sync]
        update_interval_hours = 6
        
        # ã‚«ãƒ†ã‚´ãƒª â†’ çµµæ–‡å­—ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆåŸºæœ¬ï¼‰
        [CategoryEmojis]
        shortå‹•ç”» = ðŸ“±
        ã‚«ãƒ¼ãƒ‰ = ðŸŽ´
        ã‚°ãƒƒã‚º = ðŸ§¸
        ã‚¹ãƒšã‚·ãƒ£ãƒ« = âœ¨
        ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ— = ðŸ‘‘

        # äººç‰© â†’ çµµæ–‡å­—ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆpã‚¿ã‚°ã®å†…å®¹ã‹ã‚‰åˆ¤å®šï¼‰
        [PersonEmojis]
        ã¿ãˆã‚‹å€‹äººé…ä¿¡ = ðŸ©·
        ã¿ãˆã‚‹å€‹äººch = ðŸ©·
        ãƒ¡ã‚¨å€‹äººé…ä¿¡ = ðŸ’™
        ãƒ¡ã‚¨å€‹äººch = ðŸ’™
        ãƒ‘ãƒªãƒ³å€‹äººé…ä¿¡ = ðŸ’›
        ãƒ‘ãƒªãƒ³å€‹äººch = ðŸ’›
        ãŸã„ã‚€å€‹äººé…ä¿¡ = ðŸ’œ
        ãŸã„ã‚€å€‹äººch = ðŸ’œ


        # ç‰¹åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ â†’ çµµæ–‡å­—ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆæœ€å„ªå…ˆï¼‰
        [SpecialKeywords]
        ãƒ‡ãƒŸã‚«ãƒ„é€šä¿¡ = ðŸ“°
        ã‚¢ã‚¤ã‚«ãƒ„ï¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ = ðŸ’ª
        ã‚¢ã‚¤ã‚«ãƒ„ï¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ = ðŸ”¥
        ã‚¢ã‚¤ã‚«ãƒ„ï¼ãƒ„ã‚¢ãƒ¼ã‚º = ðŸ—ºï¸
        ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼é…ä¿¡éƒ¨ = ðŸ«
        
        # ãƒãƒ£ãƒ³ãƒãƒ«URL â†’ é…ä¿¡è€…ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆGoogleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è©³ç´°ã«URLã‚’è¿½åŠ ï¼‰
        # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸Šã®[]å†…ã«è©²å½“ã—ãŸå ´åˆã€ãƒãƒ£ãƒ³ãƒãƒ«URLã‚’è¿½åŠ 
        [ChannelURLs]
        ã¿ãˆã‚‹å€‹äººé…ä¿¡ = https://www.youtube.com/@himeno-mieru
        ã¿ãˆã‚‹å€‹äººch = https://www.youtube.com/@himeno-mieru
        ãƒ¡ã‚¨å€‹äººé…ä¿¡ = https://www.youtube.com/@mamimu-meh
        ãƒ¡ã‚¨å€‹äººch = https://www.youtube.com/@mamimu-meh
        ãƒ‘ãƒªãƒ³å€‹äººé…ä¿¡ = https://www.youtube.com/@wao-parin
        ãƒ‘ãƒªãƒ³å€‹äººch = https://www.youtube.com/@wao-parin
        ãŸã„ã‚€å€‹äººé…ä¿¡ = https://www.youtube.com/@rindou-taimu
        ãŸã„ã‚€å€‹äººch = https://www.youtube.com/@rindou-taimu
        ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼é…ä¿¡éƒ¨ = https://www.youtube.com/@aikatsu-academy
        å„å€‹äººãƒãƒ£ãƒ³ãƒãƒ« = ã¿ãˆã‚‹ï¼š https://www.youtube.com/@himeno-mieru ãƒ¡ã‚¨ï¼š https://www.youtube.com/@mamimu-meh ãƒ‘ãƒªãƒ³ï¼š https://www.youtube.com/@wao-parin ãŸã„ã‚€ï¼š https://www.youtube.com/@rindou-taimu
        EOF
    
    - name: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸã‚’å®Ÿè¡Œ
      run: |
        cd src
        python main.py --manual --config ../config.ini
    
    - name: å®Ÿè¡Œçµæžœã‚’Slackã«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          message="âœ… ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸãŒæˆåŠŸã—ã¾ã—ãŸ"
        else
          message="âŒ ã‚¢ã‚¤ã‚«ãƒ„ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸãŒå¤±æ•—ã—ã¾ã—ãŸ"
        fi
        
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$message\"}" \
            $SLACK_WEBHOOK_URL
        fi 